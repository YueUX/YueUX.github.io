<!Doctype html>
<body>
	<style>
		.axis path,
		.axis line{
			stroke: #666;
			stroke-width:0.6;
			fill: none;
		}
		.lines line{
			stroke: #666;
			stroke-width:0.6;
		}
		.x line{
			stroke: none;
		}
		.x path{
			stroke-width: 2.5;
		}

		.axis text{
			font-family:"PT sans";
			fill:#888;
		}
		#yearRow{
			font-family:"PT sans";
			fill:#888;	
		}
		.title {
			font-family:"PT sans";
			fill:#888;
			font-size: 2em;			
			margin: 10px;
		}
		.slide{
			width: 750px;			
		}
		table{
			text-align:center;
		}
	</style>	
	<div class="title">
		Overview</div>
	<svg id="svg" width="1300" height="600">
		<rect class="backCanvas" width="1300" height="600" fill="white" stroke="pink" onclick="change(0)"/>	
	</svg>
	<div style="width=1000px;">
		<table align="center">
			<tr>
				<td align="center">
					<input id="slidebar" class="slide" type="range" value="0" min="0" max="2" onchange="change(this.value)"/>
				</td>	
			</tr>
			<tr>
				<td>
					<table width="1000">
						<tr id="yearRow"></tr>
					</table>
				</td>
			</tr>
			
		</table>
	</div>
</body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="data1.js"></script>
<script>
	// document.getElementById("demo").innerHTML=year.month.length;
	// fill = d3.scale.category20();	

	function clearScreen()
	{
		d3.selectAll(".backCanvas")
		.attr("opacity","1")
		.transition()
		.duration(500)
		.attr("opacity","0")
		.remove();
	}

	function pointsToGradient(points)
	{	
		if(points < 0)
			return {r:255,g:255,b:255};
		var c=[{r: 108, g:154, b:197},{r: 138, g:213, b:239},{r: 247, g:183, b:211},{r: 238, g:68, b:133}];
		if(points > 0.9)
			points = 0.9;
		var n = parseInt(points /0.33);
		var d = points - 0.33 * n;			
		var	rr = parseInt(c[n].r + (c[n+1].r - c[n].r)*d/0.33);
		var	rg =  parseInt(c[n].g + (c[n+1].g - c[n].g)*d/0.33);
		var	rb =  parseInt(c[n].b + (c[n+1].b - c[n].b)*d/0.33);
		var result = {r:rr,g:rg,b:rb};
		return result;
		
	}

	function pointsTorgb(points)
	{
		var color = pointsToGradient(points);
		return "rgb("+color.r+","+color.g+","+color.b+")";
	}
	var svg,margin;

	function draw(year){
		//Remove Remains
		clearScreen();


		//Initialize Data
		var maxy = -1;

		year.month.forEach(function(month){
			month.contact.sort(function(a,b){return a.amount-b.amount;});

			var y0 = 0;
			month.contact.forEach(function(contact){
				contact.y0 = y0;
				contact.y1 = y0 + contact.amount;
				y0 = contact.y1;			
			})
			if(y0 > maxy)
				maxy = y0;
		});
		year.month.push({monthnum: 13, contact: []});//fake month for the last line

		//Set up axis
		var monthDict = ["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec",""];
		margin = {top: 0, right: 20, bottom: 30, left: 100},
		width = 1300 - margin.left - margin.right,
		height = 600 - margin.top - margin.bottom;
		

		var x = d3.scale.linear()
		.range([0,width])
		.domain([0,13]);

		var y = d3.scale.linear()
		.range([20,height])
		.domain([maxy,0]);


		var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom")
		.tickFormat(function(d){ return monthDict[d];})
		.tickSize(0,0)
		.tickPadding(10);

		var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left")
		.tickSize(20,0)
		.tickPadding(6);

		var barWidth = (x(2)-x(1));

		//Set Up SVG
		svg = d3.select("svg")	
			.attr("height",height + margin.top + margin.bottom)
			.attr("width",width + margin.left + margin.right)
			.append("g")
			.attr("class","backCanvas")
			.attr("transform","translate(" + margin.left + "," +margin.top + ")");

		svg.append("g")
			.attr("class","x axis")
			.attr("transform","translate(0,"+height+")")
			.call(xAxis)
			.append("text")
				.attr("y",10)
				.attr("x",width-10)				
				.attr("dy",".71em")
				.style("text-anchor","middle")
				.text("Time")
				.attr("font-size","1.31em");			

		svg.append("g")
			.attr("class","y axis")
			.call(yAxis)
			.append("text")
				.attr("y",0)
				.attr("dy",".71em")
				.style("text-anchor","end")
				.text("Amount")
				.attr("font-size","1.31em");			
		
		var bars = svg.append("g")
			.attr("class","bars")
			.selectAll("g")
			.data(year.month)
			.enter().append("g")
			.attr("class","bar")
			.attr("transform",function(d){return "translate("+(x(d.monthnum) - 0.5 * barWidth)+",0)";}); 

		var contacts = bars.selectAll("rect")
			.data(function(d){return d.contact;})
			.enter().append("rect")
			.attr("class","contact")
			.on("click",goToSecondPage)
			.on("mouseover",showTag)
			.on("mousemove",moveTag)
			.on("mouseout",hideTag)			
			.attr("width",barWidth)					
			.attr("height",0)
			.attr("y",height)			
			.transition()
			.duration(1000)
			.delay(function(d,i){return 1000;})
			.attr("height",function(d){return -y(d.y1)+y(d.y0) + 1;})
			.attr("y",function(d){return y(d.y1)-2;})
			.attr("fill",function(d){return pointsTorgb(0);})
			.transition()
			.delay(function(d,i){return 2000 + Math.random() * 1000;})
			.duration(500)
			.attr("fill",function(d){return pointsTorgb(d.points);})
			

		
		var lines = svg.append("g")
			.attr("class","lines")
			.selectAll("line")
			.data(year.month)
			.enter().append("line")
			.attr("x1",function(d){return x(d.monthnum) - 0.5 * barWidth;})
			.attr("x2",function(d){return x(d.monthnum) - 0.5 * barWidth;})		
			.attr("y1",height + 50)
			.attr("y2",height + 50)
			.transition()
			.duration(1000)
			.attr("y1",0)
			.attr("stroke","black")

		var tag = svg.append("g")
			.style("pointer-events","none")
			.attr("opacity",0)
			.attr("class","nameTag");
			
			tag.append("rect")
			.attr("fill","white")
			.attr("width","120")
			.attr("height","50")
			.attr("stroke","black")
			.attr("opacity",0.8);

		var tagText = tag.append("text")
			.attr("font-family", "PT sans")
			.attr("class","tagText")
			.attr("x","20")
			.attr("y","30")
			.attr("text-anchor","start")
			.attr("font-size","1em");
			

		function showTag(element)
		{	
			tag.attr("opacity",1);
			tagText.text(element.name+", "+element.amount);
		}
		function moveTag(element)
		{			
			var pos  = d3.mouse(document.getElementById("svg"));	
			// var tag = svg.append("text")
			// .text("test")
			// .attr("x",pos[0] - margin.left)
			// .attr("y",pos[1] - margin.top);	
			// tagList.push(tag);
			var tx = x(this.parentNode.__data__.monthnum);
			var ty = pos[1] - margin.top;
			tag.attr("transform","translate("+tx+","+ty+")");
		}
		function hideTag(element)
		{	
			tag.attr("opacity",0);			
		}
	}
	status = 0;
	color = "red";
	//test 
	for(var i = 0;i < years.length;i ++)
	{
		var row = document.getElementById("yearRow");
		var cell = document.createElement("td");
		row.appendChild(cell);
		cell.innerHTML = years[i].yearnum;
	}

	d3.select("#slidebar").attr("max",years.length - 1);

	draw(years[0]);
	function change(value)
	{
		draw(years[value]);
		//status = (+status + 1) % 2;
	}
	function goToSecondPage()
	{
		document.location.href="Second.html";
	}
	


</script>
</html>